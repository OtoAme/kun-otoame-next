name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: touchgal
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install

      - name: Create .env file
        run: |
          cat <<EOF > .env
          KUN_DATABASE_URL=postgresql://postgres:password@localhost:5432/touchgal
          KUN_VISUAL_NOVEL_SITE_URL=https://example.com
          NEXT_PUBLIC_KUN_PATCH_ADDRESS_DEV=${{ secrets.NEXT_PUBLIC_KUN_PATCH_ADDRESS_DEV }}
          NEXT_PUBLIC_KUN_PATCH_ADDRESS_PROD=${{ secrets.NEXT_PUBLIC_KUN_PATCH_ADDRESS_PROD }}
          REDIS_HOST=localhost
          REDIS_PORT=6379
          JWT_ISS=touchgal
          JWT_AUD=touchgal_admin
          JWT_SECRET=dummy_secret
          NODE_ENV=production
          KUN_VISUAL_NOVEL_EMAIL_FROM=dummy
          KUN_VISUAL_NOVEL_EMAIL_HOST=dummy
          KUN_VISUAL_NOVEL_EMAIL_PORT=587
          KUN_VISUAL_NOVEL_EMAIL_ACCOUNT=dummy
          KUN_VISUAL_NOVEL_EMAIL_PASSWORD=dummy
          KUN_VISUAL_NOVEL_S3_STORAGE_ACCESS_KEY_ID=dummy
          KUN_VISUAL_NOVEL_S3_STORAGE_SECRET_ACCESS_KEY=dummy
          KUN_VISUAL_NOVEL_S3_STORAGE_BUCKET_NAME=dummy
          KUN_VISUAL_NOVEL_S3_STORAGE_ENDPOINT=https://s3.example.com
          KUN_VISUAL_NOVEL_S3_STORAGE_REGION=us-east-1
          NEXT_PUBLIC_KUN_VISUAL_NOVEL_S3_STORAGE_URL=${{ secrets.NEXT_PUBLIC_KUN_VISUAL_NOVEL_S3_STORAGE_URL }}
          KUN_VISUAL_NOVEL_IMAGE_BED_HOST=example.com
          KUN_VISUAL_NOVEL_IMAGE_BED_URL=https://example.com
          KUN_CF_CACHE_ZONE_ID=dummy
          KUN_CF_CACHE_PURGE_API_TOKEN=dummy
          KUN_VISUAL_NOVEL_INDEX_NOW_KEY=dummy
          EOF

      - name: Setup Database Schema
        run: pnpm prisma db push

      - name: Build
        run: pnpm build

      - name: Prepare Release Package
        run: |
          mkdir -p release_temp
          # Copy standalone files (using /. to ensure hidden files like .next are included)
          cp -r .next/standalone/. release_temp/

          # Ensure .next directory exists
          mkdir -p release_temp/.next

          # Explicitly copy essential build files from .next root to release_temp/.next
          # This guarantees they exist regardless of where standalone output put them
          cp .next/BUILD_ID release_temp/.next/
          cp .next/*.json release_temp/.next/ || true

          # Clean up package.json from .next if copied (we only need the root one)
          rm -f release_temp/.next/package.json

          # Copy static files
          mkdir -p release_temp/.next/static
          cp -r .next/static/. release_temp/.next/static/

          # Copy server files (required for pages-manifest.json and other server-side logic)
          mkdir -p release_temp/.next/server
          cp -r .next/server/. release_temp/.next/server/

          # Copy public files
          mkdir -p release_temp/public
          cp -r public/. release_temp/public/

          # Remove "type": "module" from package.json to avoid ReferenceError: require is not defined
          # Next.js standalone output often contains CJS code that fails if package.json forces ESM
          sed -i '/"type": "module"/d' release_temp/package.json

          cd release_temp
          tar -czf ../release.tar.gz .

      - name: Generate CalVer Tag
        id: calver
        run: |
          DATE=$(date +'%Y.%m.%d.%H%M')
          echo "tag=v$DATE" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.calver.outputs.tag }}
          name: Release ${{ steps.calver.outputs.tag }}
          files: release.tar.gz
          draft: false
          prerelease: false
